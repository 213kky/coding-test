SELECT C.CAR_ID, C.CAR_TYPE, ROUND((100-P.DISCOUNT_RATE)/100*30*C.DAILY_FEE) AS FEE
FROM CAR_RENTAL_COMPANY_CAR C
JOIN CAR_RENTAL_COMPANY_RENTAL_HISTORY H ON C.CAR_ID = H.CAR_ID
JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN P ON P.CAR_TYPE = C.CAR_TYPE AND P.DURATION_TYPE = '30일 이상'
WHERE (C.CAR_TYPE = '세단' OR C.CAR_TYPE = 'SUV') 
AND C.CAR_ID NOT IN(
    SELECT C.CAR_ID
    FROM CAR_RENTAL_COMPANY_CAR C
    JOIN CAR_RENTAL_COMPANY_RENTAL_HISTORY H ON C.CAR_ID = H.CAR_ID
    WHERE (C.CAR_TYPE = '세단' OR C.CAR_TYPE = 'SUV') 
    # 2022-10-15 ~ 2022-12-15 ❌ → 시작일도 종료일도 11월이 아님. (하지만 11월 전체를 포함하고 있음)
    # AND ((H.START_DATE BETWEEN '2022-11-01' AND '2022-11-30'
    # OR H.END_DATE BETWEEN '2022-11-01' AND '2022-11-30'))
    AND H.START_DATE <= '2022-11-30' AND H.END_DATE >= '2022-11-01'
    GROUP BY C.CAR_ID
)
AND ROUND((100-P.DISCOUNT_RATE)/100*30*C.DAILY_FEE) >= 500000 
AND ROUND((100-P.DISCOUNT_RATE)/100*30*C.DAILY_FEE) < 2000000 
GROUP BY C.CAR_ID
ORDER BY FEE DESC, C.CAR_TYPE ASC, C.CAR_ID DESC